name: Update Binaries

on:
  schedule:
    - cron: "0 20 * * *" # æ¯å¤©æ—©ä¸Š 4 ç‚¹ï¼ˆUTC 20 ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip jq yq

      - name: Run update script
        run: |
          #!/bin/bash
          set -e
          echo "ğŸŸ¦ å¼€å§‹æ‰§è¡ŒäºŒè¿›åˆ¶æ›´æ–°ä»»åŠ¡ $(date '+%F %T')"

          CONFIG_FILE="bin/binaries.yml"
          BASE_DIR="/tmp/update_binaries"
          TARGET_BASE="bin"

          mkdir -p "$BASE_DIR" "$TARGET_BASE"

          count=$(yq '.binaries | length' "$CONFIG_FILE")
          echo "ğŸ“¦ è¯»å–åˆ° $count ä¸ªäºŒè¿›åˆ¶ä»»åŠ¡"

          for ((i=0; i<count; i++)); do
            name=$(yq -r ".binaries[$i].name" "$CONFIG_FILE")
            repo=$(yq -r ".binaries[$i].repo" "$CONFIG_FILE")
            file=$(yq -r ".binaries[$i].file" "$CONFIG_FILE")
            target=$(yq -r ".binaries[$i].target" "$CONFIG_FILE")
            exec=$(yq -r ".binaries[$i].exec" "$CONFIG_FILE")
            type=$(yq -r ".binaries[$i].type" "$CONFIG_FILE")

            echo "ğŸŸ© æ›´æ–° $name..."
            tmpdir="$BASE_DIR/${name}_tmp"
            mkdir -p "$tmpdir"

            url="https://github.com/${repo}/releases/latest/download/${file}"
            pkgfile="$tmpdir/$file"

            echo "  â¬‡ï¸ ä¸‹è½½: $url"
            curl -L -o "$pkgfile" "$url"

            echo "  ğŸ“‚ è§£å‹ä¸­..."
            if [[ "$type" == "zip" ]]; then
              unzip -qo "$pkgfile" -d "$tmpdir"
            elif [[ "$type" == "tar.gz" ]]; then
              tar -xzf "$pkgfile" -C "$tmpdir"
            else
              echo "âš ï¸ ä¸æ”¯æŒçš„å‹ç¼©æ ¼å¼: $file"
              continue
            fi

            target_dir="$TARGET_BASE/$target"
            mkdir -p "$target_dir"
            rm -rf "$target_dir"/*
            mv "$tmpdir"/* "$target_dir"/

            binpath=$(find "$target_dir" -type f -name "$exec*" | head -n 1)
            if [[ -n "$binpath" ]]; then
              chmod +x "$binpath"
              echo "âœ… $name æ›´æ–°å®Œæˆ â†’ $target_dir/"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°æ‰§è¡Œæ–‡ä»¶ $exec"
            fi
          done

          echo "ğŸ‰ å…¨éƒ¨æ›´æ–°å®Œæˆ $(date '+%F %T')"

      - name: Commit and push updates
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add bin/
          git commit -m "Auto update binaries $(date '+%F %T')" || echo "No changes"
          git push || true
