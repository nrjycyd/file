name: Update Binaries

on:
  schedule:
    - cron: "0 20 * * *" # æ¯å¤©æ—©ä¸Š4ç‚¹ï¼ˆUTC 20ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip jq

      - name: Run update script
        run: |
          #!/bin/bash
          set -e
          echo "ğŸŸ¦ å¼€å§‹æ‰§è¡ŒäºŒè¿›åˆ¶æ›´æ–°ä»»åŠ¡ $(date '+%F %T')"

          # ========== é…ç½®åŒº ==========
          BASE_DIR="/tmp/update_binaries"
          TARGET_BASE="bin"   # æ‰€æœ‰ç¨‹åºå°†å­˜æ”¾åœ¨ä»“åº“çš„ bin/ ç›®å½•ä¸‹
          mkdir -p "$BASE_DIR" "$TARGET_BASE/mosdns"

          binaries=(
            "mosdns|https://github.com/yyysuo/mosdns/releases/latest/download|mosdns-linux-amd64.zip|mosdns|mosdns"
            # ç»§ç»­æ·»åŠ æ›´å¤šï¼š
            # "smartdns|https://github.com/pymumu/smartdns/releases/latest/download|smartdns-x86_64.zip|smartdns|smartdns"
            # "sing-box|https://github.com/SagerNet/sing-box/releases/latest/download|sing-box-linux-amd64.tar.gz|sing-box|sing-box"
          )
          # =============================

          update_binary() {
            local name="$1"
            local url="$2"
            local pkg="$3"
            local folder="$4"
            local bin="$5"
            local tmpdir="$BASE_DIR/${name}_tmp"

            echo "ğŸŸ© æ›´æ–° $name..."
            mkdir -p "$tmpdir"

            local pkgfile="$tmpdir/$pkg"
            echo "  â¬‡ï¸ ä¸‹è½½: $url/$pkg"
            curl -L -o "$pkgfile" "$url/$pkg"

            echo "  ğŸ“‚ è§£å‹ä¸­..."
            if [[ "$pkg" == *.zip ]]; then
              unzip -qo "$pkgfile" -d "$tmpdir"
            elif [[ "$pkg" == *.tar.gz ]]; then
              tar -xzf "$pkgfile" -C "$tmpdir"
            else
              echo "âš ï¸ ä¸æ”¯æŒçš„å‹ç¼©æ ¼å¼: $pkg"
              return
            fi

            local target_dir="$TARGET_BASE/$folder"
            mkdir -p "$target_dir"
            rm -rf "$target_dir"/*
            mv "$tmpdir"/* "$target_dir"/
            echo "âœ… $name æ›´æ–°å®Œæˆ â†’ $target_dir/"
          }

          for entry in "${binaries[@]}"; do
            IFS="|" read -r name url pkg folder bin <<< "$entry"
            update_binary "$name" "$url" "$pkg" "$folder" "$bin"
          done

          echo "ğŸ‰ å…¨éƒ¨æ›´æ–°å®Œæˆ $(date '+%F %T')"

      - name: Commit and push updates
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add bin/
          git commit -m "Auto update binaries $(date '+%F %T')" || echo "No changes to commit"
          git push || true
