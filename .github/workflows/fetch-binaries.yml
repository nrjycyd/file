name: Update Binaries

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 4:00 è‡ªåŠ¨æ‰§è¡Œï¼ˆUTC æ—¶é—´ï¼‰
    - cron: "0 20 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip jq

      - name: Run update script
        run: |
          #!/bin/bash
          set -e
          echo "ğŸŸ¦ å¼€å§‹æ‰§è¡ŒäºŒè¿›åˆ¶æ›´æ–°ä»»åŠ¡ $(date '+%F %T')"

          # ========== é…ç½®åŒºï¼ˆåªæ”¹è¿™é‡Œï¼‰ ==========
          BASE_DIR="/tmp/update_binaries"
          mkdir -p "$BASE_DIR"

          # äºŒè¿›åˆ¶æ¸…å•ï¼šåç§° | ä¸‹è½½åŸºç¡€åœ°å€ | åŒ…å | å®‰è£…ç›®å½• | ä¸»ç¨‹åºå
          binaries=(
            "mosdns|https://github.com/yyysuo/mosdns/releases/latest/download|mosdns-linux-amd64.zip|/cus/mosdns|mosdns"
            "smartdns|https://github.com/pymumu/smartdns/releases/latest/download|smartdns-x86_64.zip|/cus/smartdns|smartdns"
            # å¯ä»¥ç»§ç»­è¿½åŠ  â†“
            # "sing-box|https://github.com/SagerNet/sing-box/releases/latest/download|sing-box-linux-amd64.tar.gz|/cus/sing-box|sing-box"
          )
          # =======================================

          update_binary() {
            local name="$1"
            local url="$2"
            local pkg="$3"
            local dir="$4"
            local bin="$5"
            local tmpdir="$BASE_DIR/${name}_tmp"

            echo "ğŸŸ© æ›´æ–° $name..."
            mkdir -p "$tmpdir"

            local pkgfile="$tmpdir/$pkg"
            echo "  â¬‡ï¸ ä¸‹è½½: $url/$pkg"
            curl -L -o "$pkgfile" "$url/$pkg"

            echo "  ğŸ“‚ è§£å‹ä¸­..."
            if [[ "$pkg" == *.zip ]]; then
              unzip -qo "$pkgfile" -d "$tmpdir"
            elif [[ "$pkg" == *.tar.gz ]]; then
              tar -xzf "$pkgfile" -C "$tmpdir"
            else
              echo "âš ï¸ ä¸æ”¯æŒçš„å‹ç¼©æ ¼å¼: $pkg"
              return
            fi

            local binpath
            binpath=$(find "$tmpdir" -type f -name "$bin*" | head -n 1)
            if [[ -z "$binpath" ]]; then
              echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ $bin"
              return
            fi

            chmod +x "$binpath"
            mkdir -p "$dir"
            mv -f "$binpath" "$dir/$bin"
            echo "âœ… $name æ›´æ–°å®Œæˆ â†’ $dir/$bin"
          }

          for entry in "${binaries[@]}"; do
            IFS="|" read -r name url pkg dir bin <<< "$entry"
            update_binary "$name" "$url" "$pkg" "$dir" "$bin"
          done

          echo "ğŸ‰ å…¨éƒ¨æ›´æ–°å®Œæˆ $(date '+%F %T')"

      - name: Commit and push (optional)
        if: success()
        run: |
          # å¦‚æœè¿™äº›æ–‡ä»¶åœ¨ä»“åº“ä¸­ï¼ˆä¾‹å¦‚ä½ å­˜æ”¾äº† /cus ç›®å½•ï¼‰ï¼Œåˆ™æäº¤å˜åŠ¨
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Auto update binaries $(date '+%F %T')" || echo "No changes"
          git push || true
