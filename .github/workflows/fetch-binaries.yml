name: Update Binaries

on:
  schedule:
    - cron: "0 20 * * *" # æ¯å¤©è‡ªåŠ¨æ‰§è¡Œï¼ˆUTC 20ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          sudo apt update -y
          sudo apt install -y curl unzip jq yq tar gzip binutils

      - name: Run update script
        run: |
          #!/bin/bash
          set -e
          echo "ğŸŸ¦ å¼€å§‹æ‰§è¡ŒäºŒè¿›åˆ¶æ›´æ–°ä»»åŠ¡ $(date '+%F %T')"

          CONFIG_FILE="bin/binaries.yml"
          BASE_DIR="/tmp/update_binaries"
          TARGET_BASE="bin"
          mkdir -p "$BASE_DIR" "$TARGET_BASE"

          if [[ ! -f "$CONFIG_FILE" ]]; then
            echo "âŒ æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            exit 1
          fi

          # æ¸…ç† bin/ ä¸‹æ—§å†…å®¹ï¼Œä½†ä¿ç•™ binaries.yml
          echo "ğŸ§¹ æ¸…ç† bin/ ç›®å½•ï¼ˆä¿ç•™ binaries.ymlï¼‰"
          for item in "$TARGET_BASE"/*; do
              [[ "$item" == "$TARGET_BASE/binaries.yml" ]] && continue
              rm -rf "$item"
          done

          count=$(yq '.binaries | length' "$CONFIG_FILE")
          echo "ğŸ“¦ è¯»å–åˆ° $count ä¸ªäºŒè¿›åˆ¶ä»»åŠ¡"

          for ((i=0; i<count; i++)); do
            name=$(yq -r ".binaries[$i].name" "$CONFIG_FILE")
            repo=$(yq -r ".binaries[$i].repo" "$CONFIG_FILE")
            keyword=$(yq -r ".binaries[$i].keyword" "$CONFIG_FILE")
            exec=$(yq -r ".binaries[$i].exec" "$CONFIG_FILE")
            type=$(yq -r ".binaries[$i].type" "$CONFIG_FILE")
            extract=$(yq -r ".binaries[$i].extract" "$CONFIG_FILE")
            keep_pkg=$(yq -r ".binaries[$i].keep_pkg" "$CONFIG_FILE")

            echo "ğŸŸ© æ›´æ–° $name..."
            tmpdir="$BASE_DIR/${name}_tmp"
            mkdir -p "$tmpdir"

            echo "  ğŸ” è·å–æœ€æ–° release..."
            release_json=$(curl -s "https://api.github.com/repos/${repo}/releases/latest")

            IFS='|' read -ra keywords <<< "$keyword"
            IFS='|' read -ra types <<< "$type"
            IFS='|' read -ra extract_types <<< "$extract"
            IFS='|' read -ra keep_types <<< "$keep_pkg"

            for kw in "${keywords[@]}"; do
              for ft in "${types[@]}"; do
                echo "  ğŸ”¹ å¤„ç†ç»„åˆ: $kw.$ft"
                url=$(echo "$release_json" | jq -r ".assets[] | select(.name | contains(\"${kw}\") and endswith(\"${ft}\")) | .browser_download_url" | head -n1)
                if [[ -z "$url" ]]; then
                  echo "âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶: $kw.$ft"
                  continue
                fi

                pkgfile="$tmpdir/$(basename "$url")"
                echo "    â¬‡ï¸ ä¸‹è½½: $url"
                curl -L -o "$pkgfile" "$url"

                # åˆ¤æ–­æ˜¯å¦è§£å‹
                if [[ " ${extract_types[*]} " == *"$ft"* ]]; then
                  target_dir="$TARGET_BASE/$name/$kw"
                  mkdir -p "$target_dir"

                  echo "    ğŸ“‚ è§£å‹ä¸­..."
                  if [[ "$ft" == "zip" ]]; then
                    unzip -qo "$pkgfile" -d "$target_dir"
                  elif [[ "$ft" == "tar.gz" ]]; then
                    tar -xzf "$pkgfile" -C "$target_dir"
                  else
                    echo "âš ï¸ ä¸æ”¯æŒçš„è§£å‹æ ¼å¼: $ft"
                    continue
                  fi

                  # å¹³é“ºæ–‡ä»¶ï¼Œè¦†ç›–åŒåæ–‡ä»¶
                  shopt -s dotglob
                  for item in "$target_dir"/*; do
                    if [[ -d "$item" ]]; then
                      for sub in "$item"/*; do
                        mv -f "$sub" "$target_dir"/
                      done
                      rmdir "$item" || true
                    fi
                  done
                  shopt -u dotglob

                  # ä»…å¯¹å‹ç¼©åŒ…åˆ¤æ–­æ˜¯å¦ä¿ç•™
                  if [[ "$ft" == "zip" || "$ft" == "tar.gz" ]]; then
                    keep_this=false
                    for k in "${keep_types[@]}"; do
                      if [[ "$k" == "$ft" ]]; then
                        keep_this=true
                        break
                      fi
                    done
                    if [[ "$keep_this" != true ]]; then
                      rm -f "$pkgfile"
                    fi
                  fi

                else
                  # ä¸è§£å‹æ–‡ä»¶ï¼ˆå¦‚ deb/ipkï¼‰ç›´æ¥ç§»åŠ¨ï¼Œä¸å— keep_pkg é™åˆ¶
                  target_file="$TARGET_BASE/$name/$kw.$ft"
                  mkdir -p "$(dirname "$target_file")"
                  mv -f "$pkgfile" "$target_file"
                fi

                # è®¾ç½®å¯æ‰§è¡Œæƒé™
                binpath=$(find "$TARGET_BASE/$name/$kw" -type f -name "$exec*" 2>/dev/null | head -n1)
                if [[ -n "$binpath" ]]; then
                  chmod +x "$binpath"
                fi
              done
            done

            echo "âœ… $name æ›´æ–°å®Œæˆ"
          done

          echo "ğŸ‰ å…¨éƒ¨æ›´æ–°å®Œæˆ $(date '+%F %T')"

      - name: Commit and push updates
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add bin/
          git commit -m "Auto update binaries $(date '+%F %T')" || echo "No changes to commit"
          git push || true
