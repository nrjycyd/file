name: Fetch binaries

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼ˆå¯è°ƒæ•´ï¼‰

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install unzip
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Download all .zip assets from yyysuo/mosdns
        run: |
          mkdir -p bin/mosdns
          cd bin/mosdns

          # è·å–æ‰€æœ‰ .zip ä¸‹è½½åœ°å€ï¼ˆåŒ…æ‹¬æ‰€æœ‰ releaseï¼‰
          curl -s https://api.github.com/repos/yyysuo/mosdns/releases \
            | grep "browser_download_url" \
            | grep ".zip" \
            | cut -d '"' -f 4 > urls.txt

          echo "ğŸ“¦ æ‰¾åˆ°ä»¥ä¸‹ ZIP æ–‡ä»¶ï¼š"
          cat urls.txt

          # ä¸‹è½½æ‰€æœ‰å‹ç¼©åŒ…
          while read -r url; do
            echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ $url"
            wget -q "$url" -O "$(basename "$url")"
          done < urls.txt

      - name: Extract all zip archives
        run: |
          cd bin/mosdns
          for file in *.zip; do
            [ -e "$file" ] || continue
            folder="${file%.zip}"
            echo "ğŸ“‚ è§£å‹ï¼š$file â†’ $folder"
            mkdir -p "$folder"
            unzip -oq "$file" -d "$folder"
          done

          # æ¸…ç†å‹ç¼©åŒ…ä¸ä¸­é—´æ–‡ä»¶
          rm -f *.zip urls.txt

      - name: Commit and push changes
        run: |
          cd bin/mosdns
          if [ -n "$(git status --porcelain)" ]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "Update mosdns binaries $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
          else
            echo "âœ… æ²¡æœ‰æ›´æ–°"
          fi
