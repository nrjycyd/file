"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[166],{3596:(e,t,r)=>{r.d(t,{y:()=>o});var a=r(49900),n=r(8106);function s(e){let t=new Uint8Array(12);return window.crypto.getRandomValues(t),JSON.stringify({token:Array.from(t,e=>e.toString(16).padStart(2,"0")).join(""),expiresAt:Date.now()+1e3*e})}class i{destroy(){this.stopRefreshTokenInterval()}startRefreshTokenInterval(){this.refreshTokenIntervalId||(this.isLogin=!0,this.loadUserSettings(),a.v.debug("[AuthClient]: start refresh token."),this.refreshTokenIntervalId=setInterval(()=>{this.refreshTokens().catch(async e=>{a.v.debug("[AuthClient]: start refresh token failed.")})},this.refreshTokenInterval))}stopRefreshTokenInterval(){this.refreshTokenIntervalId&&(clearInterval(this.refreshTokenIntervalId),this.refreshTokenIntervalId=null)}checkStartRefreshTokenInterval(){localStorage.getItem("custom-auth-token")&&this.startRefreshTokenInterval()}async refreshTokens(){var e;let{data:t,error:r}=await n.Y.RefreshToken();if(r)return{error:r};let a=Number(null!=(e=null==t?void 0:t.expires_in)?e:600);a<60&&(a=60);let i=s(a);return localStorage.setItem("custom-auth-token",i),{}}async signInWithPassword(e){var t;let{username:r,password:i}=e,{data:o,error:c}=await n.Y.Login(r,i);if(c)return{error:c};let l=Number(null!=(t=null==o?void 0:o.expires_in)?t:600);l<60&&(l=60);let u=s(l);return localStorage.setItem("custom-auth-token",u),this.user.username=r,this.checkStartRefreshTokenInterval(),this.isLogin=!0,a.v.debug("[AuthClient]: sigIn"),{}}async resetPassword(e){return{error:"Password reset not implemented"}}async updatePassword(e){return{error:"Update reset not implemented"}}saveUserSettings(){localStorage.setItem("side-nav-visibility",JSON.stringify([...this.user.sideNavVisibility.entries()]))}loadUserSettings(){let e=localStorage.getItem("side-nav-visibility");if(e)try{let t=JSON.parse(e);Array.isArray(t)&&(this.user.sideNavVisibility=new Map(t))}catch(e){}}async getUser(){let e=localStorage.getItem("custom-auth-token");if(!e)return{data:null};let{error:t}=function(e){try{let t=JSON.parse(e),r=Date.now(),a=Number(t.expiresAt);if(r>a)return{error:"Token expired"};return{token:t.token}}catch(e){return{error:"Token invalid"}}}(e);return t?("Token expired"===t&&await this.signOut(),{data:null}):(this.startRefreshTokenInterval(),{data:this.user})}async signOut(){return localStorage.removeItem("custom-auth-token"),this.isLogin&&(await n.Y.Logout(),a.v.debug("[AuthClient]: signOut")),localStorage.removeItem("side-nav-visibility"),this.stopRefreshTokenInterval(),this.user.id="",this.user.username="",this.isLogin=!1,this.user.sideNavVisibility=new Map,{}}async checkLogin(){let e=await n.Y.CheckLoginStatus();if(e.error&&e.error instanceof n.i)return{error:e.error};let t=await this.getUser();return t.error?{error:t.error}:{}}constructor(){this.refreshTokenIntervalId=null,this.refreshTokenInterval=6e4,this.user={id:"",sideNavVisibility:new Map},this.isLogin=!1,n.Y.setSignOut(this.signOut.bind(this))}}let o=new i},8106:(e,t,r)=>{r.d(t,{Y:()=>i,i:()=>a});class a extends Error{constructor(e){super(e),this.name="AuthorError"}}class n{setSignOut(e){this.signOut=e}getErrorMessage(e){try{if("string"==typeof e)return e;if(e instanceof Error)return e.message;return e.error}catch(e){return"Something went wrong"}}async fetch(e,t,r,n){let s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];try{let i;if(!(i="GET"===t||"HEAD"===t||"OPTIONS"===t?await fetch(e,{method:t,headers:{"Content-Type":"application/json",...r},credentials:"include"}):await fetch(e,{method:t,headers:{"Content-Type":"application/json",...r},body:JSON.stringify(n),credentials:"include"})).ok){let e,t=i.headers.get("Content-Type");if(e=(null==t?void 0:t.includes("application/json"))?await i.json():await i.text(),401===i.status&&!s)return await this.signOut(),{error:new a(this.getErrorMessage(e))};return{error:this.getErrorMessage(e)}}if(204===i.status)return{};return{data:await i.json()}}catch(e){return{error:e}}}constructor(){this.signOut=async()=>({})}}class s{setSignOut(e){this.server.setSignOut(e)}getErrorMessage(e){return this.server.getErrorMessage(e)}async UpdatePassword(e,t){return e===t?{error:"New password must be different from old password"}:await this.server.fetch("/api/auth/password","PUT",{},{old_password:e,password:t})}async Login(e,t){return await this.server.fetch("/api/auth/login","POST",{},{username:e,password:t})}async Logout(){return this.server.fetch("/api/auth/logout","POST",{},{},!0)}async RefreshToken(){return this.server.fetch("/api/auth/refresh","POST",{},{})}async GetVersion(){return await this.server.fetch("/api/server/version","GET",{},{})}async GetLogLevel(){return await this.server.fetch("/api/log/level","GET",{},{})}async SetLogLevel(e){return this.server.fetch("/api/log/level","PUT",{},{log_level:e})}async DeleteClientById(e){return this.server.fetch("/api/client/".concat(e),"DELETE",{},{})}async DeleteQueryLogById(e){return this.server.fetch("/api/domain/".concat(e),"DELETE",{},{})}async FlushCache(){return this.server.fetch("/api/cache/flush","PUT",{},{})}async GetClients(e){let t=new URLSearchParams;return e.id&&t.append("id",e.id.toString()),e.order&&t.append("order",e.order),e.page_num&&t.append("page_num",e.page_num.toString()),e.page_size&&t.append("page_size",e.page_size.toString()),e.client_ip&&t.append("client_ip",e.client_ip),e.mac&&t.append("mac",e.mac),e.hostname&&t.append("hostname",e.hostname),e.timestamp_before&&t.append("timestamp_before",e.timestamp_before.toString()),e.timestamp_after&&t.append("timestamp_after",e.timestamp_after.toString()),e.cursor&&t.append("cursor",e.cursor.toString()),e.cursor_direction&&t.append("cursor_direction",e.cursor_direction),e.total_count&&t.append("total_count",e.total_count.toString()),await this.server.fetch("/api/client?".concat(t.toString()),"GET",{},{})}async GetQueryLogs(e){let t=new URLSearchParams;return e.id&&t.append("id",e.id.toString()),e.order&&t.append("order",e.order),e.page_num&&t.append("page_num",e.page_num.toString()),e.page_size&&t.append("page_size",e.page_size.toString()),e.domain&&t.append("domain",e.domain),e.domain_filter_mode&&t.append("domain_filter_mode",e.domain_filter_mode),e.domain_type&&t.append("domain_type",e.domain_type.toString()),e.client&&t.append("client",e.client),e.domain_group&&t.append("domain_group",e.domain_group),e.reply_code&&t.append("reply_code",e.reply_code.toString()),e.timestamp_before&&t.append("timestamp_before",e.timestamp_before.toString()),e.timestamp_after&&t.append("timestamp_after",e.timestamp_after.toString()),e.is_blocked&&t.append("is_blocked",e.is_blocked.toString()),e.is_cached&&t.append("is_cached",e.is_cached.toString()),e.cursor&&t.append("cursor",e.cursor.toString()),e.cursor_direction&&t.append("cursor_direction",e.cursor_direction),e.total_count&&t.append("total_count",e.total_count.toString()),await this.server.fetch("/api/domain?".concat(t.toString()),"GET",{},{})}async GetUpstreamServers(){let e=await this.server.fetch("/api/upstream-server","GET",{},{});return e.error?{error:e.error}:e.data?{data:e.data.upstream_server_list}:{error:"No data"}}async GetTopClients(){let e=await this.server.fetch("/api/stats/top/client","GET",{},{});return e.error?{error:e.error}:e.data?{data:e.data.client_top_list}:{error:"No data"}}async GetTopDomains(){let e=await this.server.fetch("/api/stats/top/domain","GET",{},{});return e.error?{error:e.error}:e.data?{data:e.data.domain_top_list}:{error:"No data"}}async GetSettings(){let e=await this.server.fetch("/api/config/settings","GET",{},{});return e.error?{error:e.error}:e.data?{data:e.data}:{error:"No data"}}async RestartServer(){return await this.server.fetch("/api/service/restart","PUT",{},{})}async CacheFlush(){return await this.server.fetch("/api/cache/flush","PUT",{},{})}async CacheCount(){return await this.server.fetch("/api/cache/count","GET",{},{})}async UpdateSettings(e){return this.server.fetch("/api/config/settings","PUT",{},{settings:e})}async GetOverView(){return await this.server.fetch("/api/stats/overview","GET",{},{})}async GetHourlyQueryCount(){let e=await this.server.fetch("/api/stats/hourly-query-count","GET",{},{});return e.error?{error:e.error}:e.data?{data:e.data}:{error:"No data"}}async GetDailyQueryCount(){let e=await this.server.fetch("/api/stats/daily-query-count","GET",{},{});return e.error?{error:e.error}:e.data?{data:e.data}:{error:"No data"}}async GetWhois(e){return await this.server.fetch("/api/whois?domain=".concat(e),"GET",{},{})}async CheckLoginStatus(){return this.server.fetch("/api/auth/check","GET",{},{})}constructor(){this.server=new n}}let i=new s},41444:(e,t,r)=>{r.d(t,{$b:()=>a,h:()=>i});let a={NONE:"NONE",ERROR:"ERROR",WARN:"WARN",DEBUG:"DEBUG",ALL:"ALL"},n={NONE:0,ERROR:1,WARN:2,DEBUG:3,ALL:4};class s{canWrite(e){return this.levelNumber>=n[e]}write(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];let s=this.prefix;this.showLevel&&(s="- ".concat(e," ").concat(s)),e===a.ERROR?console.error(s,...r):console.log(s,...r)}constructor({prefix:e="",level:t=a.ALL,showLevel:r=!0}){var s=this;this.debug=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.canWrite(a.DEBUG)&&s.write(a.DEBUG,...t)},this.warn=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.canWrite(a.WARN)&&s.write(a.WARN,...t)},this.error=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.canWrite(a.ERROR)&&s.write(a.ERROR,...t)},this.prefix=e,this.level=t,this.levelNumber=n[this.level],this.showLevel=r}}function i(){let{prefix:e,level:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new s({prefix:e,level:t})}},45365:(e,t,r)=>{r.d(t,{$:()=>o});var a,n=r(95704),s=r(41444),i=r(95704);let o={site:{name:"SmartDNS",description:"",themeColor:"#090a0b",url:function(){var e,t;let r=null!=(t=null!=(e=n.env.NEXT_PUBLIC_SITE_URL)?e:n.env.NEXT_PUBLIC_VERCEL_URL)?t:"http://localhost:3000/";return(r=r.includes("http")?r:"https://".concat(r)).endsWith("/")?r:"".concat(r,"/")}()},logLevel:null!=(a=i.env.NEXT_PUBLIC_LOG_LEVEL)?a:s.$b.ALL}},49900:(e,t,r)=>{r.d(t,{v:()=>n});var a=r(45365);let n=(0,r(41444).h)({level:a.$.logLevel})},56166:(e,t,r)=>{r.d(t,{Rs:()=>c,vu:()=>l});var a=r(95155),n=r(12115),s=r(3596),i=r(49900),o=r(8106);let c=n.createContext(void 0);function l(e){let{children:t}=e,[r,l]=n.useState({user:null,error:null,isLoading:!0}),u=n.useCallback(async()=>{try{let{data:e,error:t}=await s.y.getUser();if(t){i.v.error(t),l(e=>({...e,user:null,error:"Something went wrong",isLoading:!1}));return}l(t=>({...t,user:null!=e?e:null,error:null,isLoading:!1}))}catch(e){i.v.error(e),l(e=>({...e,user:null,error:"Something went wrong",isLoading:!1}))}},[]);n.useEffect(()=>{u().catch(e=>{i.v.error(e)})},[]);let h=n.useCallback(async e=>{if(e instanceof o.i)return void await (null==u?void 0:u());"string"!=typeof e&&e instanceof Error&&l(t=>({...t,user:null,error:e.message,isLoading:!1}))},[u]);return(0,a.jsx)(c.Provider,{value:{...r,checkSession:u,checkSessionError:h},children:t})}c.Consumer}}]);